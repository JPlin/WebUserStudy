<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">

    <title>Hello, world!</title>
    <script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
</head>

<body>
    <div class="left text-right">
        <div class="">
            <h1>Hello, world!</h1>
            <p class="font-weight-bold lead">Bolder weight text (relative to the parent
                element).</p>
            <blockquote class="blockquote">
                <p class="mb-0">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.
                </p>
                <footer class="blockquote-footer">Someone famous in <cite title="Source Title">Source Title</cite>
                </footer>
            </blockquote>
        </div>
        <div>
            <h2>Source</h2>
            <img src="images/train_00000014.jpg" class="source shadow-lg p-3 mb-5 bg-white rounded" alt="...">
        </div>
        <div>
            <h2>Target</h2>
            <img src="images/train_00000014.jpg" class="target shadow-lg p-3 mb-5 bg-white rounded" alt="...">
        </div>
    </div>
    <div class="right">
        <ul id="sortable" class="customerlist " style='width:100%'>
            <li class="customeritem"><img src="images/train_00000014.jpg" class="shadow p-3 mb-5 bg-white rounded"
                    alt="...">
            </li>
        </ul>
        <button type="button" class="showjson btn btn-block btn-success">保存 / 下一页</button>

        <li class="customeritem" style="display: None;"><img src="images/train_00000024.jpg"
                class="shadow p-3 mb-5 bg-white rounded" alt="...">
        </li>
    </div>

    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script type="text/javascript" src="meta_images.js"></script>
</body>

<script type="text/javascript">
    var group_index = -1;
    var global_save = [];
    $(function () {
        $("#sortable").sortable();
        $('.showjson').click();
    })

    // save user input and go to next page
    $('.showjson').on('click', function () {
        if (group_index != -1) {
            // save result 
            var temp = [];
            var t;
            $('.customerlist .customeritem').each(function (index, element) {
                t = $(this).children();
                temp.push({ "id": $(t[0]).attr('src') });
            })
            global_save.push(temp)
            console.log(temp);
            // all done
            if (group_index == meta_images.length - 1) {
                // get IP address
                $.getJSON("https://jsonip.com?callback=?", function (data) {
                    exportRaw(data.ip + '.txt', JSON.stringify(global_save));
                });
                return;
            }
        }
        group_index++;
        NextPage(meta_images[group_index]);
    })

    // replace images
    function NextPage(group_obj) {
        $('.source').attr('src', group_obj['source'])
        $('.target').attr('src', group_obj['target'])
        var url_list = group_obj['results']
        $('.customerlist li').remove();
        for (var url of url_list) {
            $('.customerlist').append('<li class="customeritem"><img src=' + url + ' class="shadow p-3 mb-5 bg-white rounded" alt = "..." ></li >');
        }
        $("ul.customerlist").sortable();
    }

    /**
     * 保存txt文件
     * @params data 文件内容
     * @params name 保存的文件名
     * @params exportRaw('result.txt', 'my,god,fuck')
     */
    function fakeClick(obj) {
        var ev = document.createEvent("MouseEvents");
        ev.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
        obj.dispatchEvent(ev);
    }

    function exportRaw(name, data) {
        var urlObject = window.URL || window.webkitURL || window;
        var export_blob = new Blob([data]);
        var save_link = document.createElementNS("http://www.w3.org/1999/xhtml", "a")
        save_link.href = urlObject.createObjectURL(export_blob);
        save_link.download = name;
        fakeClick(save_link);
    }
    /**
     * read json file from local
     */
    function loadJSON(callback) {

        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', 'meta_image.json', true); // Replace 'my_data' with the path to your file
        xobj.onreadystatechange = function () {
            if (xobj.readyState == 4 && xobj.status == "200") {
                // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                callback(xobj.responseText);
            }
        };
        xobj.send(null);
    }
</script>


</html>